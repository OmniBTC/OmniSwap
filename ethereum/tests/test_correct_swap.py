import pytest
from brownie import (
    LibCorrectSwapV2,
    CorrectUniswapV2Factory,
    CorrectUniswapV3Factory,
    CorrectOneInchFactory,
    CorrectOpenOceanFactory,
    interface
)
from scripts.helpful_scripts import get_account
from web3_input_decoder import decode_function

account = get_account()


@pytest.fixture
def lib_correct_swap_v2():
    return account.deploy(LibCorrectSwapV2)


@pytest.fixture
def correct_uniswapv2(lib_correct_swap_v2):
    return account.deploy(CorrectUniswapV2Factory, lib_correct_swap_v2.address)


@pytest.fixture
def correct_uniswapv3(lib_correct_swap_v2):
    return account.deploy(CorrectUniswapV3Factory, lib_correct_swap_v2.address)


@pytest.fixture
def correct_1inch(lib_correct_swap_v2):
    return account.deploy(CorrectOneInchFactory, lib_correct_swap_v2.address)


@pytest.fixture
def correct_openocean(lib_correct_swap_v2):
    return account.deploy(CorrectOpenOceanFactory, lib_correct_swap_v2.address)


def test_correct_uniswapv2(lib_correct_swap_v2, correct_uniswapv2):
    # swapExactETHForTokens(uint256,address[],address,uint256)
    data = "0x7ff36ab50000000000000000000000000000000000000000002a7767e41ae375e18b435f000000000000000000000000000000000000000000000000000000000000008000000000000000000000000057d1bdc3e3ca920a38b3aca0acb8853f2e76d98700000000000000000000000000000000000000000000000000000000618bed660000000000000000000000000000000000000000000000000000000000000002000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000021e783bcf445b515957a10e992ad3c8e9ff51288"

    correct_amount = int(1e18)
    uniswap_abi = interface.IUniswapV2Router02.abi

    input_data = decode_function(uniswap_abi, data)
    min_amount = input_data[0][2]
    lib_correct_swap_v2.correctSwap(data, correct_amount, {'from': account})

    (fix_min_amount, fixed_data) = lib_correct_swap_v2.fixMinAmount(data, correct_amount, {'from': account})
    assert fix_min_amount == min_amount
    input_data = decode_function(uniswap_abi, fixed_data)
    fixed_min_amount = input_data[0][2]
    assert fixed_min_amount == correct_amount + min_amount


def test_correct_uniswapv3(lib_correct_swap_v2, correct_uniswapv3):
    data = "0xc04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000331577a9af6031c3dc58c80aaf1afa9948ac44420000000000000000000000000000000000000000000000000000000060b4cc220000000000000000000000000000000000000000000000000011c37937e0800000000000000000000000000000000000000000000000000006ef0d2941076c900000000000000000000000000000000000000000000000000000000000000042c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20001f4a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480001f41f9840a85d5af5bf1d1762f925bdaddc4201f984000000000000000000000000000000000000000000000000000000000000"

    correct_amount = 1e18
    lib_correct_swap_v2.correctSwap(data, correct_amount, {'from': account})
    lib_correct_swap_v2.fixMinAmount(data, correct_amount, {'from': account})


def test_correct_oneinch(lib_correct_swap_v2, correct_1inch):
    correct_amount = 1e18

    uniswapv3_data = "0xe449022e00000000000000000000000000000000000000000000000009b6e64a8ec60000000000000000000000000000000000000000000000000000000302edc5d120d700000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000066ba59cbd09e75b209d1d7e8cf97f4ab34da413be26b9977"
    lib_correct_swap_v2.correctSwap(uniswapv3_data, correct_amount, {'from': account})
    lib_correct_swap_v2.fixMinAmount(uniswapv3_data, correct_amount, {'from': account})

    unoswap_data = "0x0502b1c5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000410f1a815b400000000000000000000000000000000000000000000be0bdf08bb88373c12b47df0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000180000000000000003b6d03405ead5462e7d98308e64bfe3c1d76845e5d2794a10bd34b36"
    lib_correct_swap_v2.correctSwap(unoswap_data, correct_amount, {'from': account})
    lib_correct_swap_v2.fixMinAmount(unoswap_data, correct_amount, {'from': account})

    swap_data = "0x12aa3caf000000000000000000000000e37e799d5077682fa0a244d46e5649f71457bd09000000000000000000000000de30da39c46104798bb5aa3fe8b9e0e1f348163f000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000e37e799d5077682fa0a244d46e5649f71457bd090000000000000000000000001e085ff3cdd38b1e5f04ace2345966056f0c85e400000000000000000000000000000000000000000000000043a77aabd0078000000000000000000000000000000000000000000000000000000a6ab6f7bef82e0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000015300000000000000000000000000000000013500011f0000e300006800004e802026678dcdde30da39c46104798bb5aa3fe8b9e0e1f348163f4a183b7ed67b9e14b3f45abfb2cf44ed22c29e54000000000000000000000000000000000000000000000000005698eef06670000020d6bdbf78de30da39c46104798bb5aa3fe8b9e0e1f348163f0c20de30da39c46104798bb5aa3fe8b9e0e1f348163fa3509a16bbfc5992eb01cc861b615ccd8e937da86ae4071118002dc6c0a3509a16bbfc5992eb01cc861b615ccd8e937da8000000000000000000000000000000000000000000000000000a6ab6f7bef82ede30da39c46104798bb5aa3fe8b9e0e1f348163f4101c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200042e1a7d4d0000000000000000000000000000000000000000000000000000000000000000c0611111111254eeb25477b68fb85ed929f73a9605820000000000000000000000000051d40aca"
    lib_correct_swap_v2.correctSwap(swap_data, correct_amount, {'from': account})
    lib_correct_swap_v2.fixMinAmount(swap_data, correct_amount, {'from': account})


def test_correct_openocean(lib_correct_swap_v2, correct_1inch, correct_openocean):
    correct_amount = 1e18

    swap_data = "0x90411a32000000000000000000000000a9c0cded336699547aac4f9de5a11ada979bc59a000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000a9c0cded336699547aac4f9de5a11ada979bc59a000000000000000000000000341a1fbd51825e5a107db54ccb3166deba14547900000000000000000000000000000000000000000000000000038d7ea4c68000000000000000000000000000000000000000000000000000000000000027ac95000000000000000000000000000000000000000000000000000000000027b6bf0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000009400000000000000000000000000000000000000000000000000000000000000a60000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038d7ea4c6800000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000004d0e30db0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000042451a74316000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000100000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064eb5625d9000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000ef2f9b48d7ec80440ab4573df1a2abdbe06d3f60000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000ef2f9b48d7ec80440ab4573df1a2abdbe06d3f60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000010438ed17390000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000a9c0cded336699547aac4f9de5a11ada979bc59affffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000007d1afa7b718fb893db30a3abc0cfc608aacfebb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000002449f8654220000000000000000000000007d1afa7b718fb893db30a3abc0cfc608aacfebb000000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000104e5b07cdb00000000000000000000000068f73e2180024db5b54e0e119d4f5128953f941700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000a9c0cded336699547aac4f9de5a11ada979bc59a00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000002e7d1afa7b718fb893db30a3abc0cfc608aacfebb0000bb8dac17f958d2ee523a2206206994597c13d831ec70000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000648a6a1e85000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000353c1f0bc78fbbc245b3c93ef77b1dcc5b77d2a0000000000000000000000000000000000000000000000000000000000027b6bf00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001a49f865422000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064d1660f99000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000341a1fbd51825e5a107db54ccb3166deba14547900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    lib_correct_swap_v2.correctSwap(swap_data, correct_amount, {'from': account})
    lib_correct_swap_v2.fixMinAmount(swap_data, correct_amount, {'from': account})

    uniswap_data = "0x8980041a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000475d0e73ca00000000000000000000000000000000000000000000000002c6cb3edd68a78ecf0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000180000000000000003b6d0340c0c3fdb6a33d1ba6b6a70d2b0e91add10be78c7a"
    lib_correct_swap_v2.correctSwap(uniswap_data, correct_amount, {'from': account})
    lib_correct_swap_v2.fixMinAmount(uniswap_data, correct_amount, {'from': account})

    uniswapv3_data = "0xbc80f1a8000000000000000000000000836ab978e8f59ffda437306645d49c78a65f7fc7000000000000000000000000000000000000000000002a5a058fc295ed0000000000000000000000000000000000000000000000000a3f174436177e2bae58130000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000280000a0000000000000000004981139acaf3362fa31e7d12f81ff4b65f881a2c800000000000000000000000d79a24bdbb24ad7d0a918387a8e5f2e193e322a1"
    lib_correct_swap_v2.correctSwap(uniswapv3_data, correct_amount, {'from': account})
    lib_correct_swap_v2.fixMinAmount(uniswapv3_data, correct_amount, {'from': account})
